FROM node:22-alpine

# 配置阿里云 Alpine 镜像源
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

WORKDIR /app

# 配置淘宝 npm 镜像源
RUN npm config set registry https://registry.npmmirror.com

# Install dependencies (cached layer)
COPY frontend/package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci

# Source code via volume mount, not COPY
EXPOSE 3000
CMD ["sh", "-c", "[ -d node_modules ] || npm ci && npx vite --host 0.0.0.0 --port 3000"]
