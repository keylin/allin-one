# Allin-One 产品方案 (PRD)

> 版本: v1.0 | 更新日期: 2026-02-12

---

## 1. 产品定位与目标

### 1.1 产品愿景
打造个人级的「信息操作系统」——从海量信息源中自动采集、智能分析、结构化呈现，让用户用最少的时间获取最高密度的信息价值。

### 1.2 目标用户
技术从业者、信息重度消费者、内容创作者等需要跟踪大量信息源的个人用户。

### 1.3 核心指标
| 指标 | 目标值 | 说明 |
|------|--------|------|
| 数据源容量 | 1,000+ | 支持同时监控的订阅源数量 |
| 日更新量 | ~2,000 条 | 每日自动采集的新内容条目 |
| 覆盖类型 | 文章/视频/音频 | 支持的媒体类型 |
| 分析延迟 | <5 分钟 | 从采集到分析完成的时间 |
| 部署方式 | 单机 Docker | 个人 VPS / NAS 即可运行 |

---

## 2. 功能架构

### 2.1 信息流 (Feed)

信息流是用户的主要内容消费界面，类似 RSS 阅读器但增强了 AI 分析能力。

**导航与筛选**
- 顶部导航栏按数据源类型和媒体类型筛选 (全部 / 文章 / 视频 / 图片)
- 支持按数据源分组浏览
- 支持时间排序 (最新 / 最早)

**信息卡片**
每条内容以卡片形式展示，支持以下操作:
- **查看原文**: 跳转原始链接或内嵌阅读器
- **展开全部**: 在页面内展开完整内容
- **AI 分析**: 查看 LLM 生成的摘要、关键观点、情感分析
- **删除**: 软删除该条目
- **收藏**: 标记为收藏，后续可快速检索

**卡片信息展示**
- 数据源标识 (图标 + 名称)
- 数据源配置链接
- 关联的 Pipeline 执行链接
- 发布时间 / 采集时间

### 2.2 数据源管理 (Sources)

**数据源管理操作**
- **新增**: 支持多种类型的数据源创建 (详见 2.2.1)
- **修改**: 编辑数据源配置 (URL、名称、采集频率等)
- **删除**: 提供两种删除模式
  - 关联内容删除: 删除数据源及其所有采集内容
  - 只删除数据源: 保留已采集内容，仅移除订阅配置
- **批量导入/导出**: 支持 OPML 格式批量导入导出 RSS 订阅

#### 2.2.1 数据源类型矩阵

数据源只描述「信息从哪来」，不涉及处理逻辑。处理方式由绑定的流水线模板决定。

| 类别 | 类型代码 | 描述 | 采集方式 |
|------|----------|------|----------|
| RSS | `rsshub` | RSSHub 生成的订阅源 | RSSHub 服务 (B站/微博/YouTube 等都走这个) |
| RSS | `rss_std` | 标准 RSS/Atom 订阅源 | feedparser 直接解析 |
| 数据 | `akshare` | AkShare 宏观经济数据 | AkShare API |
| 网页 | `scraper` | 网页抓取 | L1 HTTP / L2 Browserless / L3 browser-use |
| 文件 | `file_upload` | 用户上传文件 | Web UI 上传 |
| 账号 | `account_bilibili` | B站账号 (Cookie) | 需登录态的 API |
| 账号 | `account_other` | 其他平台账号 | 平台特定 API |
| 记录 | `user_note` | 日常笔记 | 用户手动输入 |
| 记录 | `user_message` | 用户消息 | 系统通知 |

**关键设计**: 没有 `video_bilibili` / `video_youtube` 等类型。B站/YouTube 视频通过 `rsshub` 数据源发现新内容，再由流水线中的 `download_video` 步骤处理。

**组合示例**:
| 场景 | 数据源 | 绑定的流水线模板 |
|------|--------|------------------|
| B站UP主视频分析 | `rsshub` (路由: /bilibili/user/video/12345) | "视频下载分析" |
| YouTube频道翻译 | `rsshub` (路由: /youtube/channel/UCxxx) | "视频翻译分析" |
| 英文科技博客 | `rss_std` (URL: feeds.arstechnica.com) | "英文文章翻译分析" |
| 中文新闻 | `rss_std` (URL: 36kr.com/feed) | "文章分析" |
| 公告页面监控 | `scraper` (URL + 选择器) | "文章分析" |

### 2.3 内容管理 (Content)

以表格形式管理所有采集到的内容条目，提供:
- **筛选**: 按数据源、状态 (pending/analyzed/failed)、媒体类型、时间范围
- **排序**: 按发布时间、采集时间、标题
- **去重**: 基于 `external_id` (URL) 的自动去重，支持手动去重
- **批量操作**: 选中多条内容执行批量删除或批量 AI 分析

### 2.4 仪表盘 (Dashboard)

系统运行状态概览:
- **统计概览**: 数据源总数、今日新增内容、Pipeline 执行统计
- **时间调度日志**: 最近的定时任务执行记录
- **Pipeline 执行记录**: 最近的 Pipeline 运行状态与耗时
- **异常告警**: 失败的任务与错误源高亮

### 2.5 流水线管理 (Pipelines)

**流水线配置**
- 查看所有 Pipeline 模板及其步骤定义
- 创建自定义 Pipeline 模板
- 原子操作配置 (每个步骤的参数调整)
- 可视化流水线模板编辑器（通过 Modal 选择步骤类型、配置参数、排序步骤）
- 流水线模板的启用/禁用

**执行监控**
- Pipeline 执行列表 (状态、耗时、步骤进度)
- 单个执行的步骤级详情与日志
- 失败步骤的重试操作

### 2.6 视频管理 (Video)

- **视频下载**: 通过 yt-dlp 下载 Bilibili / YouTube 视频到本地
- **视频播放**: 内嵌 Artplayer 播放器，支持本地视频播放
- **元数据展示**: 视频标题、作者、时长、清晰度
- **视频封面**: 下载时自动获取封面图（yt-dlp 优先，ffmpeg 回退）

### 2.7 账号管理 (Accounts)

管理需要登录凭证的平台账号:
- B站账号 (Cookie / 登录态)
- 其他需要认证的平台账号

### 2.8 系统配置 (Settings)

- **大模型 API**: API Key、Base URL、模型名称
- **通知配置**: 邮件、Webhook

---

## 3. 原子操作详细设计

原子操作是 Pipeline 的基本构建单元，每个操作独立、可配置、可重试。

### 3.1 抓取全文 (enrich_content)

采用三级递进策略，根据内容复杂度自动升级:

| 级别 | 方式 | 适用场景 | 成本 |
|------|------|----------|------|
| L1 | HTTP 模拟抓取 | 静态页面、API 接口 | 低 |
| L2 | 浏览器模拟抓取 (Browserless) | 需要 JS 渲染的页面 | 中 |
| L3 | browser-use (AI 操控浏览器) | 需要交互操作的页面 | 高 |

**策略**: 默认从 L1 开始尝试，如果提取内容为空或质量不佳，自动升级到下一级别。

### 3.2 文章翻译 (translate_content)

- **配置项**: 目标语言 (默认中文)
- **实现**: 调用 LLM 进行翻译，保留原文格式
- **触发条件**: 源内容语言 ≠ 目标语言时自动插入此步骤

### 3.3 下载视频 (download_video)

- **支持平台**: Bilibili、YouTube
- **实现**: yt-dlp 命令行调用
- **配置项**: 清晰度偏好、是否下载字幕、存储路径

### 3.4 音频提取 (transcribe_content)

- **状态**: 待实现
- **规划**: 使用 Whisper 或第三方 ASR 服务将视频/音频转为文字

### 3.5 模型分析 (analyze_content)

- **配置项**:
  - 模型选择: 下拉枚举 (deepseek-chat, gpt-4o, etc.)
  - 提示词: 关联 `prompt_templates` 中的模板
  - 输出格式: JSON (默认) / Markdown / Text
- **分析维度** (通过提示词配置):
  - 时间、人物、地点
  - 背景、立场、佐证
  - 摘要、关键观点
- **输出**: 结构化的分析报告 JSON，或非结构化的 Markdown/Text 文本


### 3.6 消息推送 (publish_content)

- **配置项**:
  - 渠道: Email / 钉钉 / Webhook
  - 频率: 即时 / 汇总 (按小时/天)
- **推送内容**: 标题 + AI 摘要 + 原文链接

---

## 4. 任务调度设计

采用「定时器 + 流水线」双层调度模式:

### 4.1 定时器层 (APScheduler)

| 任务类型 | 调度策略 | 说明 |
|----------|----------|------|
| 数据抓取 | 智能调度 | 根据源的更新频率动态调整，活跃源 15 分钟，低频源 2 小时 |
| 数据抓取 | 退避策略 | 连续失败时指数退避 (15min → 30min → 1h → 2h) |
| 信息流抓取 | 批量轮询 | 每轮随机选取一批源进行抓取，避免突发流量 |
| 周期任务 | 定时执行 | 日报 (每天 22:00)、周报 (每周日)、月报 (每月 1 日) |

### 4.2 流水线层 (Huey)

- 定时器触发后，为每个需要处理的内容创建一个 Pipeline 实例
- Pipeline 中的步骤由 Huey Worker 异步执行
- 支持步骤级别的并发控制 (避免 LLM API 限流)

---

## 5. 数据模型

### 5.1 内容记录 (ContentItem)

| 字段 | 说明 |
|------|------|
| 原始内容 (`raw_data`) | 采集的原始 JSON 数据包 |
| 中间内容 (`processed_content`) | 清洗/富化后的全文 |
| 最终内容 (`analysis_result`) | LLM 分析结果 |
| 发布时间 (`published_at`) | 原始内容的发布时间 |
| 采集时间 (`collected_at`) | 系统采集该内容的时间 |

### 5.2 分析结果结构 (LLM 输出)

**JSON 格式 (标准结构化输出)**:
```json
{
  "summary": "一句话摘要",
  "key_points": ["要点1", "要点2"],
  "entities": {
    "time": ["2026-02-10"],
    "people": ["张三"],
    "locations": ["北京"],
    "organizations": ["公司A"]
  },
  "background": "事件背景",
  "stance": "作者立场分析",
  "evidence": ["佐证1", "佐证2"],
  "sentiment": "positive|neutral|negative",
  "tags": ["科技", "AI"]
}
```

**Markdown / Text 格式**:
对于非结构化输出，系统会将其封装在标准 JSON 容器中：
```json
{
  "content": "# 分析报告\n\n## 摘要\n这里是 Markdown 格式的分析内容...",
  "format": "markdown"
}
```

### 5.3 用户记录 (User Records)

- **日常笔记**: 用户可对内容添加个人笔记
- **用户消息**: 系统通知与推送记录

---

## 6. 文件存储

| 类型 | 存储路径 | 说明 |
|------|----------|------|
| 视频文件 | `data/media/videos/` | yt-dlp 下载的视频 |
| 音频文件 | `data/media/audio/` | 提取的音频 (规划中) |
| 其他文件 | `data/media/files/` | 用户上传的文档等 |
| 分析报告 | `data/reports/` | LLM 生成的分析报告 |
| 数据库 | `data/db/allin.db` | SQLite 主数据库 |

---

## 7. 页面路由结构

| 路径 | 页面 | 核心功能 |
|------|------|----------|
| `/dashboard` | 仪表盘 | 系统概览、统计、告警 |
| `/feed` | 信息流 | 内容消费、AI 分析阅读 |
| `/sources` | 数据源管理 | CRUD、批量导入导出 |
| `/content` | 内容库 | 表格管理、筛选排序去重 |
| `/pipelines` | 流水线 | 执行记录、流水线模板、提示词配置 |
| `/video-download` | 视频下载 | 视频下载与播放 |
| `/settings` | 系统设置 | API Key、代理、账号 |

---

## 8. 版本规划

### v1.0 — MVP (核心采集与分析)
- [x] RSS / RSSHub 数据源采集
- [x] Pipeline 编排与执行引擎
- [x] LLM 内容分析 (摘要、关键点)
- [x] 信息流阅读界面
- [x] Docker 一键部署

### v1.1 — 视频能力增强
- [x] Bilibili / YouTube 视频下载
- [x] 视频字幕提取与分析
- [x] 内嵌视频播放器

### v1.2 — 智能调度与推送
- [ ] 智能抓取频率调整
- [ ] 日报/周报/月报自动生成
- [ ] 邮件/钉钉推送

### v2.0 — 高级功能
- [ ] browser-use AI 浏览器操控
- [ ] 多语言翻译 Pipeline
- [ ] 内容关联与知识图谱
- [ ] 用户笔记系统
