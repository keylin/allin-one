version: "3.8"

services:
  rsshub:
    image: diygod/rsshub:latest
    environment:
      - PUPPETEER_WS_ENDPOINT=ws://browserless:3000
      - NODE_ENV=production
    depends_on:
      - browserless
    networks:
      - allin-net
    restart: unless-stopped

  browserless:
    image: browserless/chrome:latest
    environment:
      - MAX_CONCURRENT_SESSIONS=5
      - CONNECTION_TIMEOUT=60000
      - MAX_QUEUE_LENGTH=10
    networks:
      - allin-net
    restart: unless-stopped

  allin-one:
    build:
      context: .
      dockerfile: docker/Dockerfile
    ports:
      - "${APP_PORT:-8000}:8000"
    volumes:
      - ./data:/app/data
      - ./data/reports:/app/reports
    environment:
      - DATABASE_URL=sqlite:///data/db/allin.db
      - RSSHUB_URL=http://rsshub:1200
      - BROWSERLESS_URL=http://browserless:3000
    env_file:
      - .env
    depends_on:
      - rsshub
      - browserless
    networks:
      - allin-net
    restart: unless-stopped

  allin-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
    command: ["python", "-m", "huey.bin.huey_consumer", "app.tasks.huey_instance.huey", "-w", "4", "-k", "thread"]
    volumes:
      - ./data:/app/data
      - ./data/reports:/app/reports
    environment:
      - DATABASE_URL=sqlite:///data/db/allin.db
      - RSSHUB_URL=http://rsshub:1200
      - BROWSERLESS_URL=http://browserless:3000
    env_file:
      - .env
    depends_on:
      - rsshub
      - browserless
    networks:
      - allin-net
    restart: unless-stopped

networks:
  allin-net:
    driver: bridge
